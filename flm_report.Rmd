---
title: "Forest Landscape Metrics (FLM)"
author: "IABG EO TEAM"
date: "2024"
output:
  pdf_document:
    toc: true
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Metrics

Explanation of metrics -- 

patch metrics

class metrics

landscape metrics

# Plots

## Patch metrics

```{r, echo = FALSE}
plot_files <- list.files(plotdir, "\\.tif$", full.names = TRUE)
```


The top 5 `patch` metrics where selected for creating maps. The `patch` metrics calculated were:
`r plot_files |> fs::path_file() |> fs::path_ext_remove() |> gsub("_", " ", x = _) |> paste0(collapse = ", ")`. `Id` is the patch id, and category is the land cover.  For more information on the other metrics, go [\textcolor{blue}{here}](https://r-spatialecology.github.io/landscapemetrics/reference/index.html#patch-level-metrics).

The category map show the land cover classification used in the FLM metrics calculation. This is the land cover map from the Copernicus Global Land Servive ([\textcolor{blue}{link}](https://land.copernicus.eu/global/products/lc)). For calculating the FLM metrics, only the forest classes are used, and all other layers are treated as a single non-forest category. 

```{r echo=FALSE, warning = FALSE, message = FALSE}

plot_crs <- terra::rast(plot_files[1]) |> terra::crs()
aoi<- aoi |> terra::project(plot_crs)
my_adm_bound <- aoi |> sf::st_as_sf() |> st_where_is(tempdir = path$proc_dir)
adm_bound <- geodata::gadm(my_adm_bound, path = path$proc_dir, level = 2)
adm_bound <- adm_bound |> terra::project(terra::crs(aoi)) |> terra::crop(terra::ext(aoi))

my_coltab<- data.frame(coltab(path$lc_raster |> terra::rast()))
my_coltab<- rbind(my_coltab, c(value = -9999, my_coltab[1,2:5]))

par(mfrow = c(2,2))
for (i in 1:length(plot_files)) {
    tmp_name <- fs::path_file(plot_files[i]) |> 
        fs::path_ext_remove()
    tmp <- terra::rast(plot_files[i])
    if(tmp_name == "category") coltab(tmp) <- my_coltab
    plot(tmp,main = tmp_name)
    plot(aoi, add = TRUE, col = "red", alpha = 0.6, legend = TRUE)
    lines(adm_bound, lwd = 2.5, alpha = 0.5, legend = TRUE)
}
par(mfrow = c(1,1))

```
